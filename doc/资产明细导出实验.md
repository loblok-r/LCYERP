## å®éªŒå‡†å¤‡

### 1.è¡¨ç»“æ„è®¾è®¡ï¼ˆç±»ä¼ä¸š ERP èµ„äº§æ˜ç»†è¡¨ï¼‰

```SQL
CREATE TABLE asset_detail (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
    
    -- åŸºç¡€ä¿¡æ¯
    asset_code VARCHAR(32) NOT NULL COMMENT 'èµ„äº§ç¼–ç ï¼ˆå”¯ä¸€ï¼‰',
    asset_name VARCHAR(100) NOT NULL COMMENT 'èµ„äº§åç§°',
    category_code VARCHAR(20) NOT NULL COMMENT 'èµ„äº§ç±»åˆ«ç¼–ç ï¼ˆå¦‚ IT01, OFFICE02ï¼‰',
    category_name VARCHAR(50) NOT NULL COMMENT 'èµ„äº§ç±»åˆ«åç§°',
    
    -- æ‰€å±ç»„ç»‡
    company_id INT NOT NULL COMMENT 'å…¬å¸ID',
    company_name VARCHAR(100) NOT NULL COMMENT 'å…¬å¸åç§°',
    dept_id INT NOT NULL COMMENT 'éƒ¨é—¨ID',
    dept_name VARCHAR(100) NOT NULL COMMENT 'éƒ¨é—¨åç§°',
    
    -- è´¢åŠ¡ä¿¡æ¯
    original_value DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'åŸå€¼ï¼ˆå…ƒï¼‰',
    residual_value DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'æ®‹å€¼ï¼ˆå…ƒï¼‰',
    depreciation_method TINYINT NOT NULL DEFAULT 1 COMMENT 'æŠ˜æ—§æ–¹æ³•ï¼ˆ1-ç›´çº¿æ³•, 2-åŒå€ä½™é¢é€’å‡ï¼‰',
    accumulated_depreciation DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'ç´¯è®¡æŠ˜æ—§',
    
    -- æ—¶é—´ä¿¡æ¯
    purchase_date DATE NOT NULL COMMENT 'é‡‡è´­æ—¥æœŸ',
    use_start_date DATE COMMENT 'å¯ç”¨æ—¥æœŸ',
    expected_life_months INT NOT NULL DEFAULT 60 COMMENT 'é¢„è®¡ä½¿ç”¨æœˆæ•°',
    
    -- çŠ¶æ€ä¸ä½ç½®
    status TINYINT NOT NULL DEFAULT 0 COMMENT 'çŠ¶æ€ï¼ˆ0-åœ¨ç”¨, 1-é—²ç½®, 2-ç»´ä¿®ä¸­, 3-æŠ¥åºŸï¼‰',
    location VARCHAR(200) COMMENT 'å­˜æ”¾ä½ç½®ï¼ˆæ¥¼æ ‹-æ¥¼å±‚-æˆ¿é—´ï¼‰',
    custodian VARCHAR(50) COMMENT 'ä¿ç®¡äºº',
    
    -- ä¾›åº”å•†ä¸åˆåŒ
    supplier_name VARCHAR(100) COMMENT 'ä¾›åº”å•†',
    contract_no VARCHAR(50) COMMENT 'åˆåŒç¼–å·',
    
    -- å®¡è®¡å­—æ®µ
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- ç´¢å¼•ï¼ˆæ¨¡æ‹ŸçœŸå®ç³»ç»Ÿï¼‰
    UNIQUE KEY uk_asset_code (asset_code),
    KEY idx_company_dept (company_id, dept_id),
    KEY idx_purchase_date (purchase_date),
    KEY idx_category (category_code),
    KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='èµ„äº§æ˜ç»†è¡¨';
```

### 2.æ•°æ®è§„æ¨¡è®¾å®š

| ä¼ä¸šç±»å‹               | èµ„äº§æ€»é‡         | è¯´æ˜                                                         |
| ---------------------- | ---------------- | ------------------------------------------------------------ |
| å°å‹ä¼ä¸š               | < 10ä¸‡           | ä¸è¶³ä»¥è§¦å‘ OOM                                               |
| **ä¸­å¤§å‹ä¼ä¸šï¼ˆæ¨èï¼‰** | **80ä¸‡ ~ 200ä¸‡** | âœ… **æœ€ä½³å®éªŒåŒºé—´**ï¼š â€¢ è¶³å¤Ÿå¤§ï¼Œèƒ½ OOM â€¢ æœ¬åœ°å¯ç”Ÿæˆ/å¯¼å…¥ â€¢ ç¬¦åˆé›†å›¢å‹ä¼ä¸šèµ„äº§è§„æ¨¡ï¼ˆå¦‚åˆ¶é€ ã€é‡‘èã€èƒ½æºè¡Œä¸šï¼‰ |
| è¶…å¤§å‹ä¼ä¸š             | > 500ä¸‡          | æœ¬åœ°æµ‹è¯•å¯èƒ½è€—æ—¶è¿‡é•¿                                         |

### ğŸ”¢ æ¨èå®éªŒæ•°æ®é‡ï¼š**120 ä¸‡æ¡**

- æŒ‰ **5 å®¶å­å…¬å¸** åˆ†å¸ƒï¼ˆ`company_id`: 1001~1005ï¼‰
- æ¯å®¶å…¬å¸ **20~30 ä¸ªéƒ¨é—¨**
- èµ„äº§ç±»åˆ«ï¼šITè®¾å¤‡ï¼ˆ40%ï¼‰ã€åŠå…¬å®¶å…·ï¼ˆ30%ï¼‰ã€ç”Ÿäº§è®¾å¤‡ï¼ˆ20%ï¼‰ã€è½¦è¾†ï¼ˆ10%ï¼‰
- é‡‡è´­æ—¥æœŸï¼šé›†ä¸­åœ¨ **2019-01-01 è‡³ 2024-12-31**ï¼ˆ6å¹´ï¼‰
- çŠ¶æ€åˆ†å¸ƒï¼šåœ¨ç”¨ï¼ˆ75%ï¼‰ã€é—²ç½®ï¼ˆ15%ï¼‰ã€ç»´ä¿®ï¼ˆ7%ï¼‰ã€æŠ¥åºŸï¼ˆ3%ï¼‰

> ğŸ’¡ ä¸ºä»€ä¹ˆé€‰ 120wï¼Ÿ
>
> - å…¨é‡åŠ è½½åˆ° Java å¯¹è±¡ â‰ˆ **120w Ã— 500B = 600MB å¯¹è±¡æ•°æ®**ï¼›
> - åŠ ä¸Š POI å†…å­˜å¼€é”€ã€JVM å¯¹è±¡å¤´ã€GC å¼€é”€ â†’ **ææ˜“åœ¨ -Xmx2g ä¸‹ OOM**ï¼›
> - å¯¼å‡ºæ—¶é—´ > 8 åˆ†é’Ÿï¼Œç”¨æˆ·ä½“éªŒå·®ï¼Œé—®é¢˜æ˜æ˜¾ã€‚

### 3.å¯¼å…¥ä¾èµ–

```xml
 <dependency>
            <groupId>org.apache.poi</groupId>
            <artifactId>poi-ooxml</artifactId>
            <version>5.2.4</version>
</dependency>
```

### 4.ç”Ÿæˆæµ‹è¯•æ•°æ®

æ’å…¥160wæ¡æ•°æ®

æ•°æ®åˆ†å¸ƒ 

company_name     COUNT(*)  

---------------  ----------
é›†å›¢æ€»éƒ¨                 320635
åä¸œåˆ†å…¬å¸                319230
åå—åˆ†å…¬å¸                319730
ååŒ—åˆ†å…¬å¸                320633
è¥¿éƒ¨åˆ†å…¬å¸                319772

æ•°æ®çŠ¶æ€

status_text  COUNT(*)  
-----------  ----------
åœ¨ç”¨              1200244
é—²ç½®               239977
ç»´ä¿®ä¸­              111657
æŠ¥åºŸ                48122

é‡‡è´­å¹´ä»½åˆ†å¸ƒ

YEAR(purchase_date)  COUNT(*)  
-------------------  ----------
               2019      266801
               2020      267450
               2021      266458
               2022      266092
               2023      265635
               2024      267564

## å…¨é‡å¯¼å‡ºå®éªŒ

##### 1.å…¨é‡åŠ è½½æ•°æ®åˆ°å†…å­˜    

160wæ•°æ®å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åå†™å…¥åˆ°åˆ›å»ºçš„excelä¸­

##### 2.ä½¿ç”¨ `XSSFWorkbook`ï¼ˆå…¨å†…å­˜ Excel æ¨¡å‹ï¼‰

æµ‹è¯•å‡ºç°OOM

```text
Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread "File Watcher"
Exception in thread "http-nio-8029-Poller" Exception in thread "mysql-cj-abandoned-connection-cleanup" java.lang.OutOfMemoryError: Java heap space
java.lang.OutOfMemoryError: Java heap space
2025-11-13T10:53:25.698+08:00 ERROR 24832 --- [alina-utility-2] org.apache.catalina.core.ContainerBase   : Exception processing background thread

java.util.concurrent.ExecutionException: java.lang.OutOfMemoryError: Java heap space
	at java.base/java.util.concurrent.FutureTask.report(FutureTask.java:122) ~[na:na]
	at java.base/java.util.concurrent.FutureTask.get(FutureTask.java:191) ~[na:na]
	at org.apache.catalina.core.ContainerBase.threadStart(ContainerBase.java:1226) ~[tomcat-embed-core-10.1.16.jar:10.1.16]
	at org.apache.catalina.core.ContainerBase$ContainerBackgroundProcessorMonitor.run(ContainerBase.java:1270) ~[tomcat-embed-core-10.1.16.jar:10.1.16]
	at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:539) ~[na:na]
	at java.base/java.util.concurrent.FutureTask.runAndReset(FutureTask.java:305) ~[na:na]
	at java.base/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:305) ~[na:na]
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136) ~[na:na]
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635) ~[na:na]
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61) ~[tomcat-embed-core-10.1.16.jar:10.1.16]
	at java.base/java.lang.Thread.run(Thread.java:842) ~[na:na]
Caused by: java.lang.OutOfMemoryError: Java heap space

2025-11-13T10:53:25.830+08:00 ERROR 24832 --- [nio-8029-exec-2] o.a.c.c.C.[.[.[/].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Handler dispatch failed: java.lang.OutOfMemoryError: Java heap space] with root cause

java.lang.OutOfMemoryError: Java heap space
	at java.base/java.util.Arrays.copyOf(Arrays.java:3512) ~[na:na]
	at java.base/java.util.Arrays.copyOf(Arrays.java:3481) ~[na:na]
	at java.base/java.util.ArrayList.grow(ArrayList.java:237) ~[na:na]
	at java.base/java.util.ArrayList.grow(ArrayList.java:244) ~[na:na]
	at java.base/java.util.ArrayList.add(ArrayList.java:454) ~[na:na]
	at java.base/java.util.ArrayList.add(ArrayList.java:467) ~[na:na]
	at org.apache.xmlbeans.impl.store.Saver.addMapping(Saver.java:623) ~[xmlbeans-5.1.1.jar:na]
	at org.apache.xmlbeans.impl.store.Saver.<init>(Saver.java:102) ~[xmlbeans-5.1.1.jar:na]
	at org.apache.xmlbeans.impl.store.Saver$SynthNamespaceSaver.<init>(Saver.java:793) ~[xmlbeans-5.1.1.jar:na]
	at org.apache.xmlbeans.impl.store.Saver.<init>(Saver.java:117) ~[xmlbeans-5.1.1.jar:na]
	at org.apache.xmlbeans.impl.store.Saver$TextSaver.<init>(Saver.java:834) ~[xmlbeans-5.1.1.jar:na]
	at org.apache.xmlbeans.impl.store.Cursor._xmlText(Cursor.java:535) ~[xmlbeans-5.1.1.jar:na]
	at org.apache.xmlbeans.impl.store.Cursor.lambda$xmlText$11(Cursor.java:1982) ~[xmlbeans-5.1.1.jar:na]
	at org.apache.xmlbeans.impl.store.Cursor$$Lambda$1648/0x00000251cb9bea08.get(Unknown Source) ~[na:na]
	at org.apache.xmlbeans.impl.store.Cursor.syncWrapHelper(Cursor.java:2529) ~[xmlbeans-5.1.1.jar:na]
	at org.apache.xmlbeans.impl.store.Cursor.syncWrap(Cursor.java:2460) ~[xmlbeans-5.1.1.jar:na]
	at org.apache.xmlbeans.impl.store.Cursor.xmlText(Cursor.java:1982) ~[xmlbeans-5.1.1.jar:na]
	at org.apache.xmlbeans.impl.values.XmlObjectBase.xmlText(XmlObjectBase.java:1447) ~[xmlbeans-5.1.1.jar:na]
	at org.apache.poi.xssf.model.SharedStringsTable.xmlText(SharedStringsTable.java:141) ~[poi-ooxml-5.2.4.jar:5.2.4]
	at org.apache.poi.xssf.model.SharedStringsTable.addEntry(SharedStringsTable.java:191) ~[poi-ooxml-5.2.4.jar:5.2.4]
	at org.apache.poi.xssf.model.SharedStringsTable.addSharedStringItem(SharedStringsTable.java:223) ~[poi-ooxml-5.2.4.jar:5.2.4]
	at org.apache.poi.xssf.usermodel.XSSFCell.setCellValueImpl(XSSFCell.java:370) ~[poi-ooxml-5.2.4.jar:5.2.4]
	at org.apache.poi.xssf.usermodel.XSSFCell.setCellValueImpl(XSSFCell.java:353) ~[poi-ooxml-5.2.4.jar:5.2.4]
	at org.apache.poi.ss.usermodel.CellBase.setCellValue(CellBase.java:275) ~[poi-5.2.4.jar:5.2.4]
	at cn.loblok.lcyerp01.service.AssetExportServiceV1.exportAllToFile(AssetExportServiceV1.java:47) ~[classes/:na]
	at cn.loblok.lcyerp01.controller.AssetController.exportV1Debug(AssetController.java:36) ~[classes/:na]
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:na]
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77) ~[na:na]
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:na]
	at java.base/java.lang.reflect.Method.invoke(Method.java:568) ~[na:na]
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:254) ~[spring-web-6.1.1.jar:6.1.1]
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:182) ~[spring-web-6.1.1.jar:6.1.1]
```



## æ¸¸æ ‡åˆ†é¡µæŸ¥è¯¢ + `SXSSFWorkbook` æµå¼å†™ å¯¼å‡ºå®éªŒ

### 1. **é€‰æ‹©ç¨³å®šçš„æ’åºå­—æ®µ**

- å¿…é¡»æ˜¯ å”¯ä¸€ã€éç©ºã€æœ‰åºçš„å­—æ®µï¼Œé€šå¸¸æ˜¯ï¼š
  - ä¸»é”® `id`ï¼ˆè‡ªå¢ï¼‰
  - æˆ– `(create_time, id)` ç»„åˆï¼ˆé˜²é‡å¤ï¼‰

### 2. **åˆ†é¡µé€»è¾‘ï¼šæ¯æ¬¡æŸ¥ â€œ> ä¸Šä¸€æ‰¹æœ€å¤§ idâ€ çš„ N æ¡**

```sql
SELECT * FROM asset_detail 
WHERE id > :lastId 
ORDER BY id ASC 
LIMIT 1000;
```

### 3. **æµå¼å†™å…¥ Excel**

- ä½¿ç”¨ `SXSSFWorkbook(rowAccessWindowSize)` æ§åˆ¶å†…å­˜è¡Œæ•°ï¼ˆå¦‚ 100ï¼‰
- æ¯å¤„ç†ä¸€æ‰¹æ•°æ®å°± flush åˆ°ç£ç›˜ä¸´æ—¶æ–‡ä»¶
- æœ€ç»ˆä¸€æ¬¡æ€§å†™å‡ºåˆ° HTTP å“åº”æµ

### 4. **èµ„æºç®¡ç†**

- åŠæ—¶å…³é—­ workbookï¼ˆè°ƒç”¨ `dispose()` åˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼‰
- ä½¿ç”¨ try-with-resources é˜²æ­¢å†…å­˜/æ–‡ä»¶æ³„æ¼

## æ–‡ä»¶ä¸‹è½½çš„åº•å±‚å®ç°

Controller æ–¹æ³•**å‚æ•°åŒ…å« `HttpServletResponse`**ï¼Œå¹¶ä¸” **è¿”å› `void`**ï¼ŒSpring å°±ä¼šè®¤ä¸ºï¼š

> â€œè¿™ä¸ªæ–¹æ³•è¦è‡ªå·±æ§åˆ¶ HTTP å“åº”å†…å®¹ï¼Œæˆ‘ä¸å†å¸®ä½ è‡ªåŠ¨å†™ JSONã€‚â€

äºæ˜¯ï¼Œä½ å¯ä»¥ï¼š

- ç›´æ¥å¾€ `response.getOutputStream()` å†™äºŒè¿›åˆ¶æ•°æ®ï¼ˆå¦‚ Excelã€PDFã€å›¾ç‰‡ï¼‰
- è®¾ç½®æ­£ç¡®çš„ `Content-Type`
- è®¾ç½®æ–‡ä»¶ä¸‹è½½å¤´ `Content-Disposition`

âœ… **è¿™å°±æ˜¯â€œæ–‡ä»¶ä¸‹è½½â€çš„åº•å±‚å®ç°æ–¹å¼ã€‚**

**è¿™ç§æ–¹æ³•ä¸æ˜¯â€œè¿”å›æ•°æ®â€ï¼Œè€Œæ˜¯â€œç›´æ¥å¾€ç½‘ç»œè¿æ¥é‡ŒçŒ Excel æ–‡ä»¶â€ï¼Œæµè§ˆå™¨æ¥åˆ°åè‡ªåŠ¨ä¿å­˜ä¸ºæ–‡ä»¶ã€‚**

**Excel `.xlsx` æ–‡ä»¶å•ä¸ª Sheet æœ€å¤šåªèƒ½æœ‰ 1,048,576 è¡Œï¼ˆå³ 2Â²â° = 1048576ï¼‰**

### æ¨èã€‘è‡ªåŠ¨åˆ† Sheetï¼ˆæ¯æ»¡ 100 ä¸‡è¡Œæ–°å»ºä¸€ä¸ª Sheetï¼‰

è¿™æ˜¯å¤„ç†è¶…ç™¾ä¸‡æ•°æ®å¯¼å‡ºçš„æ ‡å‡†åšæ³•ã€‚

ç»“æœï¼š

APIFOXæµ‹è¯•  200 59.17 s 91.86 M

ä¸‹è½½æ–‡ä»¶ assets_export_1763005683127.xlsx  ï¼Œåˆ†ä¸¤ä¸ªsheetï¼Œæ•°æ®æ— è¯¯


## å¤šçº¿ç¨‹å¹¶è¡Œ åˆ†ç‰‡ + `CompletableFuture` + åˆå¹¶








